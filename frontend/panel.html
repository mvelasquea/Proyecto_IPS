<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Principal - Supervisión Fraude Combustible</title>
    <link rel="stylesheet" href="css/home.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      /* Estilos para los botones de subir archivo y subir y analizar */
      .file-input-container input[type="file"] {
        background: #fff;
        color: #255381;
        border-radius: 6px;
        padding: 7px 10px;
        border: 2px solid #255381;
        font-size: 1rem;
        cursor: pointer;
        width: 260px;
        transition: border 0.2s, box-shadow 0.2s;
      }
      .file-input-container input[type="file"]:focus {
        border: 2px solid #00b4d8;
        box-shadow: 0 0 0 2px #caf0f8;
        outline: none;
      }
      #submitBtn {
        background: linear-gradient(90deg, #255381 60%, #00b4d8 100%);
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 28px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 180, 216, 0.15);
        transition: background 0.2s, transform 0.2s;
        margin-left: 10px;
      }
      #submitBtn:disabled {
        background: #bdbdbd;
        color: #fff;
        cursor: not-allowed;
      }
      #submitBtn:hover:not(:disabled) {
        background: linear-gradient(90deg, #00b4d8 60%, #255381 100%);
        transform: translateY(-2px) scale(1.04);
      }
      .result-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 30px;
      }
      .result-card {
        background: #042f5a;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .chart-container {
        width: 100%;
        height: 400px;
        margin-top: 20px;
      }
      .progress-bar {
        height: 5px;
        background: #103d6b;
        margin: 10px 0;
        border-radius: 5px;
        overflow: hidden;
      }
      .progress {
        height: 100%;
        background: #28a745;
        width: 0%;
        transition: width 0.3s;
      }
      #dataPreview {
        margin-top: 20px;
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #767883;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #767883;
      }
      tr:nth-child(even) {
        background-color: #767883;
      }
      .file-requirements {
        background-color: #255381;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo"><i class="fas fa-gas-pump"></i> Panel Principal</div>
        <nav>
          <ul>
            <li><a href="home.html">Inicio</a></li>
            <li><a href="panel.html" class="active">Panel principal</a></li>
            <li><a href="#analisis">Análisis</a></li>
            <li><a href="#subida">Subida de archivo</a></li>
          </ul>
        </nav>
      </header>

      <section class="live-fuel-monitoring">
        <h2>Bienvenido al Panel Principal</h2>
        <p>
          Aquí puedes analizar los datos de consumo de combustible, subir nuevos
          archivos y visualizar resultados de detección de anomalías.
        </p>

        <!-- Subida de archivo -->
        <h3 id="subida">Subir archivo de consumo de combustible</h3>

        <div class="file-requirements">
          <h4><i class="fas fa-info-circle"></i> Requisitos del archivo:</h4>
          <ul>
            <li>Formatos aceptados: .xlsx, .xls, .csv</li>
            <li>
              Columnas requeridas: Vehículo, Fecha, Galones, Kilometraje, Costo
            </li>
            <li>Tamaño máximo: 20MB</li>
            <li>Datos deben estar en la primera hoja del archivo</li>
          </ul>
        </div>

        <form id="uploadForm" enctype="multipart/form-data">
          <div class="file-input-container">
            <input
              type="file"
              id="fileInput"
              name="file"
              accept=".xlsx,.xls,.csv"
              required />
            <button type="submit" id="submitBtn">Subir y analizar</button>
          </div>
          <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
          </div>
          <div id="fileInfo" style="margin: 10px 0"></div>
        </form>
        <button id="btnDescargarPDF" class="btn btn-primary">Descargar Reporte PDF</button>
        <!-- Vista previa de datos -->
        <div id="dataPreview">
          <h4>Vista previa de los datos:</h4>
          <div id="previewTable"></div>
        </div>

        <!-- Resultados del análisis -->
        <div id="analisis">
          <h3>Resultados del Análisis</h3>
          <div id="analisisResultados" class="result-container">
            <!-- Se llenará dinámicamente -->
          </div>

          <div class="chart-container">
            <canvas id="efficiencyChart"></canvas>
          </div>

          <div class="chart-container">
            <canvas id="anomaliesChart"></canvas>
          </div>
        </div>
      </section>
    </div>

    <script src="js/api/fuelApi.js"></script>
    <script>
      // Configuración inicial
      const fileInput = document.getElementById("fileInput");
      const progressBar = document.getElementById("progressBar");
      const fileInfo = document.getElementById("fileInfo");
      const submitBtn = document.getElementById("submitBtn");
      const previewTable = document.getElementById("previewTable");

      // Mostrar información del archivo seleccionado
      fileInput.addEventListener("change", async (e) => {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          fileInfo.innerHTML = `
                    <strong>Archivo seleccionado:</strong> ${file.name}<br>
                    <strong>Tamaño:</strong> ${(
                      file.size /
                      1024 /
                      1024
                    ).toFixed(2)} MB
                `;

          // Mostrar vista previa del archivo
          try {
            const data = await readFile(file);
            displayPreview(data);
          } catch (error) {
            console.error("Error al leer el archivo:", error);
            previewTable.innerHTML = `<p class="error">No se pudo leer el archivo. Verifique el formato.</p>`;
          }
        }
      });

      // Función para leer el archivo (Excel o CSV)
      async function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });

              // Tomar la primera hoja
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

              // Convertir a JSON
              const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                header: 1,
              });

              // Procesar los datos
              const headers = jsonData[0];
              const rows = jsonData.slice(1);

              const processedData = rows.map((row) => {
                const obj = {};
                headers.forEach((header, index) => {
                  obj[header] = row[index];
                });
                return obj;
              });

              resolve({
                headers: headers,
                data: processedData,
              });
            } catch (error) {
              reject(error);
            }
          };

          reader.onerror = function (error) {
            reject(error);
          };

          reader.readAsArrayBuffer(file);
        });
      }

      // Mostrar vista previa de los datos
      function displayPreview(data) {
        if (!data || !data.data || data.data.length === 0) {
          previewTable.innerHTML =
            "<p>No se encontraron datos en el archivo.</p>";
          return;
        }

        let tableHTML = "<table><thead><tr>";

        // Encabezados
        data.headers.forEach((header) => {
          tableHTML += `<th>${header}</th>`;
        });
        tableHTML += "</tr></thead><tbody>";

        // Mostrar solo las primeras 5 filas para la vista previa
        data.data.slice(0, 5).forEach((row) => {
          tableHTML += "<tr>";
          data.headers.forEach((header) => {
            tableHTML += `<td>${row[header] || ""}</td>`;
          });
          tableHTML += "</tr>";
        });

        tableHTML += "</tbody></table>";
        tableHTML += `<p>Mostrando ${Math.min(5, data.data.length)} de ${
          data.data.length
        } registros</p>`;

        previewTable.innerHTML = tableHTML;
      }

      // Manejar envío del formulario al backend real
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const file = fileInput.files[0];
          if (!file) {
            Swal.fire("Error", "Por favor selecciona un archivo", "error");
            return;
          }

          // Validar tamaño del archivo (max 20MB)
          if (file.size > 20 * 1024 * 1024) {
            Swal.fire(
              "Error",
              "El archivo es demasiado grande (máximo 20MB)",
              "error"
            );
            return;
          }

          submitBtn.disabled = true;
          progressBar.style.width = "0%";

          try {
            // Mostrar progreso
            progressBar.style.width = "30%";

            // Enviar archivo al backend
            const response = await FuelApi.uploadFile(file);
            progressBar.style.width = "60%";

            // Procesar respuesta
            displayResults(response);
            progressBar.style.width = "100%";

            Swal.fire("Éxito", "Archivo analizado correctamente", "success");
          } catch (error) {
            console.error("Error:", error);
            Swal.fire(
              "Error",
              error.message || "Ocurrió un error al procesar el archivo",
              "error"
            );
          } finally {
            submitBtn.disabled = false;
          }
        });

      // Función para mostrar resultados desde el backend
      function displayResults(response) {
        const resultadosDiv = document.getElementById("analisisResultados");
        const data = response.data;
        const stats = response.stats;

        // Estadísticas principales
        resultadosDiv.innerHTML = `
          <div class="result-card">
              <h4><i class="fas fa-tachometer-alt"></i> Eficiencia de Combustible</h4>
              <p>Promedio: <strong>${
                stats.eficiencia?.promedio?.toFixed(2) || "N/A"
              } km/gal</strong></p>
              <p>Mínimo: ${
                stats.eficiencia?.min?.toFixed(2) || "N/A"
              } km/gal</p>
              <p>Máximo: ${
                stats.eficiencia?.max?.toFixed(2) || "N/A"
              } km/gal</p>
          </div>
          
          <div class="result-card">
              <h4><i class="fas fa-exclamation-triangle"></i> Anomalías Detectadas</h4>
              <p>Total: <strong>${stats.anomalias?.total || 0}</strong></p>
              <p>Críticas: ${stats.anomalias?.criticas || 0}</p>
              <p>Porcentaje: ${
                stats.anomalias?.porcentaje?.toFixed(2) || 0
              }%</p>
          </div>
          
          <div class="result-card">
              <h4><i class="fas fa-gas-pump"></i> Consumo</h4>
              <p>Total: S/. ${stats.consumo?.total?.toFixed(2) || "N/A"}</p>
              <p>Promedio: S/. ${
                stats.consumo?.promedio?.toFixed(2) || "N/A"
              }</p>
          </div>
          
          <div class="result-card">
              <h4><i class="fas fa-car"></i> Vehículos</h4>
              <p>Total analizados: ${stats.vehiculos?.total || 0}</p>
              <p>Más eficiente: ${stats.vehiculos?.mas_eficiente || "N/A"}</p>
              <p>Menos eficiente: ${
                stats.vehiculos?.menos_eficiente || "N/A"
              }</p>
          </div>
        `;

        // Gráfico de eficiencia (si hay datos)
        if (stats.eficiencia) {
          renderEfficiencyChart({
            labels: ["Mínimo", "Promedio", "Máximo"],
            values: [
              stats.eficiencia.min,
              stats.eficiencia.promedio,
              stats.eficiencia.max,
            ],
          });
        }

        // Gráfico de anomalías (si hay datos)
        if (stats.anomalias) {
          renderAnomaliesChart({
            normal: data.length - stats.anomalias.total,
            anomalias: stats.anomalias.total,
          });
        }

        // Mostrar tabla con datos relevantes
        renderDataTable(data.slice(0, 10));
      }

      // Funciones para gráficos (usando Chart.js)
      function renderEfficiencyChart(data) {
        const ctx = document.getElementById("efficiencyChart").getContext("2d");

        // Destruir gráfico anterior si existe
        if (window.efficiencyChart) {
          window.efficiencyChart.destroy();
        }

        window.efficiencyChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: "Eficiencia (km/gal)",
                data: data.values,
                backgroundColor: "rgba(54, 162, 235, 0.7)",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Resumen de Eficiencia",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "km/gal",
                },
              },
            },
          },
        });
      }

      function renderAnomaliesChart(data) {
        const ctx = document.getElementById("anomaliesChart").getContext("2d");

        // Destruir gráfico anterior si existe
        if (window.anomaliesChart) {
          window.anomaliesChart.destroy();
        }

        window.anomaliesChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Normales", "Anomalías"],
            datasets: [
              {
                data: [data.normal, data.anomalias],
                backgroundColor: ["#4bc0c0", "#ff6384"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Distribución de Anomalías",
              },
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      // Función para mostrar tabla de datos
      function renderDataTable(data) {
        if (!data || data.length === 0) return;

        // Obtener las columnas/headers
        const headers = Object.keys(data[0]);

        let tableHTML =
          '<h4>Muestra de Datos Analizados</h4><div style="overflow-x: auto;"><table><thead><tr>';

        // Encabezados
        headers.forEach((header) => {
          tableHTML += `<th>${header}</th>`;
        });
        tableHTML += "</tr></thead><tbody>";

        // Filas de datos
        data.forEach((row) => {
          tableHTML += "<tr>";
          headers.forEach((header) => {
            tableHTML += `<td>${row[header] || ""}</td>`;
          });
          tableHTML += "</tr>";
        });

        tableHTML += "</tbody></table></div>";

        // Agregar al contenedor de resultados
        const resultadosDiv = document.getElementById("analisisResultados");
        const tableContainer = document.createElement("div");
        tableContainer.className = "result-card";
        tableContainer.innerHTML = `<h4><i class="fas fa-table"></i> Datos Analizados</h4>${tableHTML}`;
        resultadosDiv.appendChild(tableContainer);
      }

      // Verificar conexión con el backend al cargar la página
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const health = await FuelApi.getHealthStatus();
          console.log("API Status:", health);

          if (health.status !== "active") {
            Swal.fire({
              icon: "warning",
              title: "Advertencia",
              text: "El servidor de análisis no está disponible",
              timer: 3000,
            });
          }
        } catch (error) {
          console.error("Error checking API health:", error);
        }
      });
    </script>
    <script> 
    document.getElementById('btnDescargarPDF').onclick = function() {
          fetch('http://localhost:5000/api/descargar_pdf')
          .then(response => {
              if (!response.ok) throw new Error('No se pudo descargar el PDF');
              return response.blob();
          })
          .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'reporte.pdf';
              document.body.appendChild(a);
              a.click();
              a.remove();
          })
          .catch(err => alert(err.message));
    };  
    </script>
  </body>
</html>
